<html>
<head>
  <script>
    fetch('/user').then(res => res.json()).then(json => {
      const first_name = document.getElementById("first_name")
      first_name.value = json.first_name
      const last_name = document.getElementById("last_name")
      last_name.value = json.last_name
      const email = document.getElementById("email")
      email.value = json.email
      const phone = document.getElementById("school")
      school.value = json.school
      const type = document.getElementById("type")
      type.value = json.type
      });

    fetch('/subscriptions').then(res => res.json()).then(json => {
      if (Object.keys(json).length > 0) {
        const curr_subs = document.getElementById("curr-subs");
        curr_subs.hidden = false;
        Object.keys(json).forEach(key => {
          const newDiv = document.createElement("div");
          newDiv.id = key;
          let loc = key.split("_");
          if (loc.length > 1)
            loc[loc.length - 1] = loc[loc.length - 1].toUpperCase();
          const parsed = [];
          loc.forEach((elem, idx) => {
            if (idx == loc.length - 1)
              parsed[idx] = elem.toUpperCase();
            else {
              parsed[idx] = elem.charAt(0).toUpperCase() + elem.slice(1);
            }
          });
          console.log(parsed);
          let p = document.createElement("p");
          let text = document.createTextNode("Location: " + parsed.join(" "));
          p.appendChild(text);
          newDiv.appendChild(p);
          console.log(json[key]);
          const keys = document.createElement("p");
          text = document.createTextNode("Keywords: ");
          keys.appendChild(text);
          newDiv.appendChild(keys);
          json[key].forEach(element => {
            p = document.createElement("p");
            p.id = element;
            p.style.marginBottom = "0";
            text = document.createTextNode(element);
            p.appendChild(text);
            keys.appendChild(p);
          });
          curr_subs.appendChild(newDiv);
        });
      }
    });

    window.onload = function() {
      const keywords = document.getElementById("key");
      const loc = document.getElementById("loc");
      const sub_button = document.getElementById("sub-button");
      sub_button.addEventListener("click", function () {
        if (keywords.value.trim().length <= 0 || loc.value.trim().length <= 0) {
          let check = document.getElementById("alert-msg");
          if (check != null) return;
          let alert_msg = document.createElement("p");
          alert_msg.id = "alert-msg";
          let msg = document.createTextNode("Please enter keywords and location");
          let subscribe = document.getElementById("subscribe");
          alert_msg.appendChild(msg);
          alert_msg.style.textAlign = "center";
          alert_msg.style.fontSize = "15";
          alert_msg.style.margin = "0";
          let sub_box = document.getElementById("sub-box");
          subscribe.appendChild(alert_msg);
          return;
        }
        fetch('/subscribe', 
              {
                method: "POST",
                body: '{ "key": ' + JSON.stringify(keywords.value) + ', "loc":' + JSON.stringify(loc.value) + '}',
                headers: {'Content-Type': 'application/json'}
              }).then(function(){keywords.value = ""; loc.value = "";});
      });
    } 

  </script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <title>User Settings</title>
    
</head>
<body>
  <div class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <a class="navbar-brand" href="/homepage">Job Search</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/savedjobs">Saved Jobs</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="recently_applied">Recently Applied</a>
        </li>
        <li class="nav-item">
          <!-- Replace with search icon-->
          <a class="nav-link" href="/job_search">Search</a>
        </li>
        <li class="nav-item">
          <!-- Replace with person icon-->
          <a class="nav-link" href="/settings">Settings</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/logout">Logout</a>
        </li>

      </ul>
    </div>

  </div>
    <h1>User Settings</h1> 
    <div class = "container">
        <div class="center-box">
            <form action="/settings" method="post" name="form1">
              E-mail
              <div class = "form-row">
                  <input type="email" name="email" id="email" aria-describedby="nameHelp" placeholder="abc@gmail.com" value="" size="50" class="line-input" readonly> <br><br>
              </div>
                First name
            <div class = "form-row">
                <input type="first_name" name="first_name" id="first_name" aria-describedby="nameHelp" placeholder="John" value="" size="50" class="line-input" readonly><br><br>
            </div>
            Last name
            <div class = "form-row">
                <input type="last_name" name="last_name" id="last_name" aria-describedby="nameHelp" placeholder="Smith" value="" size="50" class="line-input" readonly> <br><br>
            </div>
            School/Organization
            <div class = "form-row">
                <input type="school" name="school"  id="school" aria-describedby="school" placeholder="San Jose State University" value="" size="50" class="line-input" readonly><br><br>
            </div>
            Type of account:
            <div class = "form-row">
              <input type="type" name="type"  id="type" aria-describedby="type" placeholder="student/recruiter" value="" size="50" class="line-input" readonly><br><br>
            </div>
            Old-Password
            <div class = "form-row">
                <input type="password" name="old_password" id="old_password" aria-describedby="password" placeholder="*********" value="" size="50" class="line-input"> <br><br>
            </div>
            New-Password
            <div class = "form-row">
                <input type="password" name="new_password" id="new_password" aria-describedby="password" placeholder="*********" value="" size="50" class="line-input"> <br><br>
            </div>
            <input type="submit" class="btn btn-primary" value="Save changes"><br><br>
            </form> 
        </div>
        <div id="sub-box" style="width: 300; height: 350; margin-left: 250;">
          <div id="subscribe" style="width: 300; height: 350;">
          <h4 style="text-align: center;">Subscribe</h4>
          <p style="text-align: center;">Subscribe to receive email notifications when new jobs are posted</p>
          Keywords
          <div class="form-row" style="margin-top: 5;">
            <input type="key" name="key" id="key" aria-describedby="Keywords" placeholder="engineer" value="" size="40" class="line-input"/>
          </div>
          Location
          <div class="form-row" style="margin-top: 5;">
            <input type="location" name="loc" id="loc" aria-describedby="Location" placeholder="Mountain View, CA" value="" size="40" class="line-input"/>
          </div>
          <input class="btn btn-primary" style="width: 200; height: 30; margin-left: 50; margin-bottom: -10px;" value="Subscribe" id="sub-button"><br><br>
          </div>
          <div hidden id="curr-subs">
            <h5 style="text-align: center;" id="curr-title">Current Subscriptions</h5>
          </div>
        </div>
    </div>
</body>
</html>